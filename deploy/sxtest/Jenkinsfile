pipeline {
  agent {
    kubernetes {
      yamlFile 'deploy/sxtest/KubernetesPod.yaml'
      retries 2
    }
  }

  environment {
    IMAGE_REPO = "SXKJ:32775"
    TAB = "\n   \n  "
  }
  stages {
    stage('git-log') {
      steps {
        script{
            sh "git log --oneline -n 1 > gitlog.file"
            env.GIT_LOG = readFile("gitlog.file").trim()
        }
        sh 'printenv'
       }
    }
    stage('构建镜像') {
      steps {
        container('docker') {
          echo "构建 Docker 镜像阶段"
          sh 'docker build  -t ${IMAGE_REPO}/meta-app:latest --output type=docker .'
          echo "build success"
        }
        script {
          env.BUILD_TASKS = env.STAGE_NAME + "✅" + env.TAB
        }
      }
    }
    stage('镜像推送') {
      steps {
        container('docker') {
          echo "Push Docker 镜像阶段"
          sh 'docker push ${IMAGE_REPO}/meta-app:latest '
          echo "Push image success"
        }
        script {
          env.BUILD_TASKS = env.STAGE_NAME + "✅" + env.TAB
        }
      }
    }
    stage('重启服务') {
      steps {
        container('kubectl') {
          sh 'kubectl version'
        }
        script {
          env.BUILD_TASKS = env.STAGE_NAME + "✅" + env.TAB
        }
        sh 'printenv'
      }
    }
  }
}