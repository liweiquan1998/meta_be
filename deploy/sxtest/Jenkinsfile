pipeline {
  agent {
    kubernetes {
      yamlFile 'deploy/sxtest/KubernetesPod.yaml'
      retries 2
    }
  }

  environment {
    IMAGE_REPO = "SXKJ:32775"
    TAB = "\n   \n  "
  }
  stages {
    stage('git-log') {
      steps {
        script{
            sh "git log --oneline -n 1 > gitlog.file"
            env.GIT_LOG = readFile("gitlog.file").trim()
        }
        sh 'printenv'
       }
    }
    stage('æ„å»ºé•œåƒ') {
      steps {
        container('docker') {
          echo "æ„å»º Docker é•œåƒé˜¶æ®µ"
          sh 'docker build  -t ${IMAGE_REPO}/meta-app:latest --output type=docker .'
          echo "build success"
        }
        script {
          env.BUILD_TASKS = env.STAGE_NAME + "âœ…" + env.TAB
        }
      }
    }
    stage('é•œåƒæ¨é€') {
      steps {
        container('docker') {
          echo "Push Docker é•œåƒé˜¶æ®µ"
          sh 'docker push ${IMAGE_REPO}/meta-app:latest '
          echo "Push image success"
        }
        script {
          env.BUILD_TASKS += env.STAGE_NAME + "âœ…" + env.TAB
        }
      }
    }
    stage('é‡å¯æœåŠ¡') {
      steps {
        container('kubectl') {
          sh 'kubectl version'
        }
        script {
          env.BUILD_TASKS += env.STAGE_NAME + "âœ…" + env.TAB
        }
        sh 'printenv'
      }
    }
  }
  post {
    success {
        echo 'Congratulations!'
        sh """
            curl 'https://oapi.dingtalk.com/robot/send?access_token=19195ef5d3ce080a6966db554d03a348b56cd7c42707deebee51a353fdb2cc7d' \
                -H 'Content-Type: application/json' \
                -d '{
                    "msgtype": "markdown",
                    "markdown": {
                        "title":"metabe-sxtest",
                        "text": "ğŸ˜„ğŸ‘ æ„å»ºæˆåŠŸ ğŸ‘ğŸ˜„  \n**é¡¹ç›®åç§°**ï¼šjairmir  \n**Git log**: ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME}   \n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}"
                    }
                }'
        """
    }
    failure {
        echo 'Oh no!'
        sh """
            curl 'https://oapi.dingtalk.com/robot/send?access_token=19195ef5d3ce080a6966db554d03a348b56cd7c42707deebee51a353fdb2cc7d' \
                -H 'Content-Type: application/json' \
                -d '{
                    "msgtype": "markdown",
                    "markdown": {
                        "title":"metabe-sxtest",
                        "text": "ğŸ˜–âŒ æ„å»ºå¤±è´¥ âŒğŸ˜–  \n**é¡¹ç›®åç§°**ï¼šjairmir  \n**Git log**: ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME}  \n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}"
                    }
                }'
        """
    }
    always {
        echo 'I will always say Hello again!'
    }
  }
}